name: Deploy Specific Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - audit-service
          - boundary-service
          - egov-accesscontrol
          - egov-enc-service
          - egov-filestore
          - egov-idgen
          - egov-indexer
          - egov-localization
          - egov-location
          - egov-notification-mail
          - egov-notification-sms
          - egov-otp
          - egov-persister
          - egov-pg-service
          - egov-url-shortening
          - egov-workflow-v2
          - gateway
          - internal-gateway-scg
          - mdms-v2
          - service-request
          - user-otp
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      version:
        description: 'Version/Tag to deploy (leave empty for latest)'
        required: false
        default: 'latest'

env:
  MAVEN_OPTS: -Xmx3072m
  JAVA_VERSION: '17'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  build-service:
    name: Build ${{ github.event.inputs.service }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build service
        working-directory: ./core-services/${{ github.event.inputs.service }}
        run: mvn clean package -DskipTests
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.service }}-jar
          path: core-services/${{ github.event.inputs.service }}/target/*.jar
          retention-days: 1

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-service
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event.inputs.version }}" == "latest" ]; then
            TAG="${{ github.sha }}"
          else
            TAG="${{ github.event.inputs.version }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $TAG"
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./core-services
          file: ./core-services/build/maven/Dockerfile
          build-args: |
            WORK_DIR=${{ github.event.inputs.service }}
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ github.event.inputs.service }}:${{ steps.image-tag.outputs.tag }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ github.event.inputs.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-service:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: build-docker
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://${{ github.event.inputs.environment }}.yourdomain.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}
      
      - name: Update deployment image
        run: |
          kubectl set image deployment/${{ github.event.inputs.service }} \
            ${{ github.event.inputs.service }}=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ github.event.inputs.service }}:${{ needs.build-docker.outputs.image-tag }} \
            -n ${{ github.event.inputs.environment }}
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/${{ github.event.inputs.service }} \
            -n ${{ github.event.inputs.environment }} \
            --timeout=5m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ github.event.inputs.environment }} \
            -l app=${{ github.event.inputs.service }}
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests for ${{ github.event.inputs.service }}"
          # Add your smoke test commands here
          # Example: curl -f https://${{ github.event.inputs.environment }}.yourdomain.com/health

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-service, build-docker, deploy-service]
    if: always()
    
    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Service Deployment
            Service: ${{ github.event.inputs.service }}
            Environment: ${{ github.event.inputs.environment }}
            Version: ${{ github.event.inputs.version }}
            Status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
